<% layout("layouts/boilerplate") -%>

<div class="container py-5 text-center">
  <h2 class="fw-bold mb-3">Confirm Your Booking</h2>

  <p class="text-muted mb-4">
    Total Amount:
    <span class="fw-semibold text-dark">
      ₹ <%= totalAmount.toLocaleString("en-IN") %>
    </span>
  </p>

  <button
    id="payBtn"
    class="btn text-white px-5 py-2 rounded-pill"
    style="background: linear-gradient(90deg, #ff385c, #ff4d6d);">
    Pay Now
  </button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.getElementById("payBtn").onclick = async () => {
  try {
    // 1️⃣ Create Razorpay Order (SERVER decides amount)
    const res = await fetch("/bookings/<%= booking._id %>/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) {
      alert("Failed to create payment order");
      return;
    }

    const order = await res.json();

    // 2️⃣ Open Razorpay Checkout
    const options = {
      key: "<%= razorpayKey %>",
      amount: order.amount, // paise
      currency: "INR",
      name: "Wanderlust",
      description: "Booking Payment",
      order_id: order.id,

      handler: async function (response) {
        // 3️⃣ Verify Payment
        const verifyRes = await fetch(
          "/bookings/<%= booking._id %>/verify-payment",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_signature: response.razorpay_signature
        })

          }
        );

        const result = await verifyRes.json();

        if (result.success) {
          window.location.href = "/listings/<%= booking.listing._id %>";
        } else {
          alert("Payment verification failed");
        }
      },

      modal: {
        ondismiss: function () {
          alert("Payment cancelled");
        }
      },

      theme: { color: "#ff385c" }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (err) {
    console.error(err);
    alert("Payment initialization failed");
  }
};
</script>
